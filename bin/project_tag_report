#! /usr/bin/env ruby

require File.expand_path(File.dirname(__FILE__) + '/../config/boot')

def help(error_msg)
  abort "#{error_msg}\n\nUsage:\n    ./bin/project_tag_report PROJECT_TAG\n"
end

help "Incorrect number of arguments." unless ARGV.size == 1

project_tag = ARGV.shift 

query_tag = "project_tag_facet:\"#{project_tag}\""

resp = Dor::SearchService.query query_tag, :rows => 50000, :fl => 'id, public_dc_title_t, wf_wps_facet, source_id_t, objectLabel_t, content_file_t'

project_file_name = project_tag.gsub(' ','_').gsub('"','')

help "no results found for project tag '#{project_tag}'" if resp.docs.size == 0 

report_filename="../log/#{project_file_name}_tag_report.csv"

puts "Running report with #{resp.docs.size} objects"

CSV.open(File.join(File.expand_path(File.dirname(__FILE__)),report_filename), "wb") do |csv|

  # header row 
  csv << ["druid", "label", "dc:title", "source_id", "accessioned", "shelved", "purl", "total_files", "files_found"] 
  resp.docs.each {|doc|	csv << Assembly::Utils.solr_doc_parser(doc)}
	puts "Report written to #{report_filename}"
	
end
